{"componentChunkName":"component---src-templates-post-jsx","path":"/yui-introduction","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://github.com/dark-flames/Yui\">Yui</a> 是笔者使用<code class=\"language-text\">Rust</code>编写的第一个项目，本来是准备写一个ORM，但是在处理attribute的过程中写了很多重复的代码，所以决定将这一部分单独抽象成一个lib。</p>\n<h3 id=\"核心功能\" style=\"position:relative;\"><a href=\"#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD\" aria-label=\"核心功能 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>核心功能</h3>\n<p>Yui 的核心功能是根据 AttributeStructure 定义的 attribute pattern 匹配 <code class=\"language-text\">syn</code>中的 attribute 结构</p>\n<h4 id=\"定义attributestructure\" style=\"position:relative;\"><a href=\"#%E5%AE%9A%E4%B9%89attributestructure\" aria-label=\"定义attributestructure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>定义AttributeStructure</h4>\n<p>Yui 可以使用 Rust 中的<code class=\"language-text\">struct</code>定义 AttributeStructure，匹配过程中将会依照 AttributeStructure 作为 pattern 进行处理。同时，<code class=\"language-text\">Struct Struct</code>、<code class=\"language-text\">Tuple Struct</code>和<code class=\"language-text\">NoField Struct</code>均可以用于定义 AttributeStructure。</p>\n<p>Yui 提供了名为<code class=\"language-text\">yui::YuiAttribute</code>的 derive 宏，会为 AttributeStructure 生成 <code class=\"language-text\">yui::AttributeStructure</code>、<code class=\"language-text\">quote::ToTokens</code>和<code class=\"language-text\">syn::parse_macro_input::ParseMacroInput</code>的相关实现。所有使用了这个宏的 struct 均可以作为 AttributeStructure 使用。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> yui<span class=\"token punctuation\">::</span>YuiAttribute<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> NoField<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token function\">Tuple</span><span class=\"token punctuation\">(</span>i32<span class=\"token punctuation\">,</span> String<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Struct <span class=\"token punctuation\">{</span>\n    int<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">,</span>\n    float<span class=\"token punctuation\">:</span> f64<span class=\"token punctuation\">,</span>\n    bool<span class=\"token punctuation\">:</span> bool<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"attributefield的类型\" style=\"position:relative;\"><a href=\"#attributefield%E7%9A%84%E7%B1%BB%E5%9E%8B\" aria-label=\"attributefield的类型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AttributeField的类型</h4>\n<p>AttributeStructure 的每一个 field 均对应了所匹配 attribute 中的一个字段。可以使用如下类型：</p>\n<ul>\n<li>String: Rust 中的 <code class=\"language-text\">String</code>类型。</li>\n<li>Bool: Rust 中的 <code class=\"language-text\">bool</code>类型。</li>\n<li>Integer: Rust 中任意整数类型如<code class=\"language-text\">i32</code>、<code class=\"language-text\">u32</code>等。</li>\n<li>Float: Rust 中任意浮点类型如 <code class=\"language-text\">f32</code>、<code class=\"language-text\">f64</code>等。</li>\n<li>Enum: 已经定义的 EnumValue，详见 <a href=\"#enumvalue\">EnumValue</a>。</li>\n<li>Object: 其他已经定义的 AttributeStructure。</li>\n<li>Vec&#x3C;T>: 包含 T 类型的 Vec（T不可为 Object、Vec 或者 HashMap）。</li>\n<li>HashMap&#x3C;String, T>: 以 String 作为键的T类型HashMap。</li>\n</ul>\n<p>如果想要将一个字段设为可选字段，只需要将其对应 field 的类型标记为<code class=\"language-text\">Option&lt;T&gt;</code>即可。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> yui<span class=\"token punctuation\">::</span><span class=\"token punctuation\">{</span>YuiEnumValue<span class=\"token punctuation\">,</span> YuiAttribute<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Bar<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiEnumValue)]</span>\n<span class=\"token keyword\">enum</span> SomeEnum <span class=\"token punctuation\">{</span>\n    A<span class=\"token punctuation\">,</span>\n    B\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Foo <span class=\"token punctuation\">{</span>\n    string<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n    bool<span class=\"token punctuation\">:</span> bool<span class=\"token punctuation\">,</span>\n    int<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">,</span>\n    float<span class=\"token punctuation\">:</span> f32<span class=\"token punctuation\">,</span>\n    object<span class=\"token punctuation\">:</span> Bar<span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[attribute_field(enum_value=true)]</span>\n    enum_field<span class=\"token punctuation\">:</span> SomeEnum<span class=\"token punctuation\">,</span>\n    list<span class=\"token punctuation\">:</span> Vec<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    map<span class=\"token punctuation\">:</span> std<span class=\"token punctuation\">::</span>collections<span class=\"token punctuation\">::</span>HashMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> SomeEnum<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    optional<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span> <span class=\"token comment\">// 可选字段</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"enumvalue\" style=\"position:relative;\"><a href=\"#enumvalue\" aria-label=\"enumvalue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EnumValue</h4>\n<p>在 <code class=\"language-text\">enum</code> 上使用<code class=\"language-text\">yui::YuiEnumValue</code>后，可以将其作为 EnumValue 使用。在解析 attribute 时，会将字段的字符串值自动转换为字符串对应的 variant。</p>\n<p>同时，也可以在每一个 variant 上使用<code class=\"language-text\">variant_value</code> attribute 来定义它所对应的字符串值。对于未定义的 variant，Yui 将会使用它的标识符（转换为 <code class=\"language-text\">snake_case</code>）作为它对应的字符串值。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> yui<span class=\"token punctuation\">::</span>YuiEnumValue<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(YuiEnumValue)]</span>\n<span class=\"token keyword\">enum</span> SomeEnum <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[variant_value(\"aaa\")]</span>\n    A<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 对应的字符串为\"aaa\"</span>\n    B  <span class=\"token comment\">// 对应的字符串为\"b\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意，将 field 设为<code class=\"language-text\">Enum</code>类型时，需要为其添加<code class=\"language-text\">enum_value=true</code>的选项，以与<code class=\"language-text\">Object</code>类型区别，详见<a href=\"#%E9%80%89%E9%A1%B9\">选项</a>。\n除此之外，<code class=\"language-text\">variant_value</code>暂时仅支持字符串值。</p>\n<h4 id=\"选项\" style=\"position:relative;\"><a href=\"#%E9%80%89%E9%A1%B9\" aria-label=\"选项 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>选项</h4>\n<p>在 field 上使用<code class=\"language-text\">attribute_field</code>可以设置相关选项：</p>\n<ul>\n<li>\n<p>alias<br>\n重新设置 field 对应的字段名，默认为 field 的标识符(转换为<code class=\"language-text\">snake_case</code>)。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Foo <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[attribute_field(alias = \"i32\")]</span>\n    <span class=\"token keyword\">pub</span> int32<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>default<br>\n默认值，如果 attribute 中这个字段未给出，则将其设置为默认值。对于可选的字段，将会以<code class=\"language-text\">Some(default_value)</code>的形式给出。如果一个非可选字段在 attribute 中未被赋值并且没有设置默认值，处理过程中将会报错。<br>\n<code class=\"language-text\">Object</code>、<code class=\"language-text\">Vec</code>和<code class=\"language-text\">HashMap</code>类型无法设置默认值，对于<code class=\"language-text\">Enum</code>类型的字段，请将默认值设置为 variant 对应的字符串值。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Foo <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[attribute_field(default = 1024)]</span>\n    <span class=\"token keyword\">pub</span> int32<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[attribute_field(default = \"string\")]</span>\n    <span class=\"token keyword\">pub</span> string<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[attribute_field(default = \"aaa\", enum_value=true]</span>\n    <span class=\"token keyword\">pub</span> enum_value<span class=\"token punctuation\">:</span> SomeEnum\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>enum_value<br>\n用于区别<code class=\"language-text\">Enum</code>和<code class=\"language-text\">Object</code>类型。如果这个字段为<code class=\"language-text\">Enum</code>类型，请将这个字段设置为<code class=\"language-text\">true</code>。</li>\n</ul>\n<h4 id=\"关于code-classlanguage-textobjectcode类型\" style=\"position:relative;\"><a href=\"#%E5%85%B3%E4%BA%8Ecode-classlanguage-textobjectcode%E7%B1%BB%E5%9E%8B\" aria-label=\"关于code classlanguage textobjectcode类型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>关于<code class=\"language-text\">Object</code>类型</h4>\n<p>由于 Rust attribute 语法所限。当一个字段类型为<code class=\"language-text\">Object</code>时，其所对应的 AttributeStructure 的标识符将会失去作用。具体匹配的 attribute 请参照如下例子。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> yui<span class=\"token punctuation\">::</span>YuiAttribute<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 这一 AttributeStruture 匹配的 attribute 为 #[Fool(test=114514)]</span>\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Foo <span class=\"token punctuation\">{</span>\n    test<span class=\"token punctuation\">:</span> i32\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 这一 AttributeStruture 匹配的 attribute 为 #[Bar(fool_field(test=114514))]</span>\n<span class=\"token attribute attr-name\">#[derive(YuiAttribute)]</span>\n<span class=\"token keyword\">struct</span> Bar <span class=\"token punctuation\">{</span>\n    foo_field<span class=\"token punctuation\">:</span> Fool<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"使用code-classlanguage-textsyncode-读取-attribute\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8code-classlanguage-textsyncode-%E8%AF%BB%E5%8F%96-attribute\" aria-label=\"使用code classlanguage textsyncode 读取 attribute permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用<code class=\"language-text\">syn</code> 读取 attribute</h4>\n<ul>\n<li>\n<p>使用<code class=\"language-text\">syn</code>解析<code class=\"language-text\">TokenStream</code><br>\n如果你只需要读取最外层结构（<code class=\"language-text\">struct</code>、<code class=\"language-text\">enum</code>或<code class=\"language-text\">tuple</code>）上的 attribute, 可以直接使用 <code class=\"language-text\">syn::parse_macro_input!</code>。\n同时，Yui 提供了<code class=\"language-text\">yui::AttributeStructures</code>用来包裹多个 AttributeStructure。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> attributes <span class=\"token operator\">=</span> syn<span class=\"token punctuation\">::</span><span class=\"token function\">parse_macro_inpit!</span><span class=\"token punctuation\">(</span>input <span class=\"token keyword\">as</span> yui<span class=\"token punctuation\">::</span>AttributeStructs<span class=\"token operator\">&lt;</span>Foo<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>\n<p>从<code class=\"language-text\">syn::Meta</code>创建 AttributeStructure<br>\n如果你想解析其他位置的 attribute，请获取其对应的<code class=\"language-text\">syn::Meta</code>对象后使用<code class=\"language-text\">yui::AttributeStructure::from_meta()</code>方法。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> meta <span class=\"token operator\">=</span> attr<span class=\"token punctuation\">.</span><span class=\"token function\">parse_meta</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> attributes <span class=\"token operator\">=</span> Foo<span class=\"token punctuation\">::</span><span class=\"token function\">from_meta</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>meta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>\n<p>从<code class=\"language-text\">syn::AttributeArgs</code>创建 AttributeStructure<br>\n如果你已经获取了 attribute 对应的<code class=\"language-text\">syn::AttributeArgs</code>对象，可以使用<code class=\"language-text\">yui::AttributeStructure::from_attribute_args()</code>方法获取 AttributeStructure。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> attributes <span class=\"token operator\">=</span> Foo<span class=\"token punctuation\">::</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_attribute_args</span><span class=\"token punctuation\">(</span>attribute_args<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<h4 id=\"使用code-classlanguage-textquotecode符号化-attributestructure\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8code-classlanguage-textquotecode%E7%AC%A6%E5%8F%B7%E5%8C%96-attributestructure\" aria-label=\"使用code classlanguage textquotecode符号化 attributestructure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用<code class=\"language-text\">quote</code>符号化 AttributeStructure</h4>\n<p>AttributeStructure 被自动实现了 <code class=\"language-text\">quote::ToTokens</code>，可以直接使用<code class=\"language-text\">quote::quote!</code>将其符号化。</p>\n<p>注意，如果要使用此功能，需要将 AttributeStructure 的所有 field 设置为<code class=\"language-text\">pub</code>，并且为其添加<code class=\"language-text\">Clone</code> derive 宏。</p>\n<p>由于输出的 TokenStream 是 AttributeStructure 的构造表达式，所以无法将其赋值给<code class=\"language-text\">static</code>或者<code class=\"language-text\">const</code>，请使用<code class=\"language-text\">lazy_static</code>或者将其作为函数的返回值。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> attributes <span class=\"token operator\">=</span> Foo<span class=\"token punctuation\">::</span><span class=\"token function\">from_meta</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>meta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nquote<span class=\"token punctuation\">::</span><span class=\"token macro-rules function\">quote!</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">get_attrs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> Foo <span class=\"token punctuation\">{</span>\n        #attributes\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"扩展功能：reader-generator\" style=\"position:relative;\"><a href=\"#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%EF%BC%9Areader-generator\" aria-label=\"扩展功能：reader generator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>扩展功能：Reader Generator</h3>\n<p>提供了用于生成默认 Reader 的过程宏 <code class=\"language-text\">yui::generate_reader!</code>。同时提供了运行时读取attribute的工具宏<code class=\"language-text\">yui::get_attribute!</code>和<code class=\"language-text\">yui::has_attribute!</code>。</p>\n<p>如果要使用此功能，请打开<code class=\"language-text\">generate-reader</code> feature。</p>\n<h5 id=\"生成-derive-宏\" style=\"position:relative;\"><a href=\"#%E7%94%9F%E6%88%90-derive-%E5%AE%8F\" aria-label=\"生成 derive 宏 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生成 Derive 宏</h5>\n<p>如果想要使用<code class=\"language-text\">yui::get_attribute</code>和<code class=\"language-text\">yui::has_attribute</code>。首先需要使用<code class=\"language-text\">yui::generate_reader!</code>生成一个 derive 宏，任何使用了这个宏的对象均可以使用<code class=\"language-text\">yui::get_attribute</code>和<code class=\"language-text\">yui::has_attribute</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\">yui<span class=\"token punctuation\">::</span><span class=\"token function\">generate_reader!</span><span class=\"token punctuation\">(</span>DeriveName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>StructAttr<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>FieldAttr<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>第一个参数为 Derive 的标识符。第二个参数为读取结构上 AttributeStructure 的列表，第三个可选参数为读取 Field 上 AttributeStructure 的列表。\n请在这一文件中<code class=\"language-text\">use</code>所需要的所有 AttributeStructure。</p>\n<p><code class=\"language-text\">yui::generate_reader!</code>将会生成一个<code class=\"language-text\">pub</code>的 derive 宏，所以请为你的 lib 打开<code class=\"language-text\">proc_macro</code>。</p>\n<h4 id=\"读取-attribute\" style=\"position:relative;\"><a href=\"#%E8%AF%BB%E5%8F%96-attribute\" aria-label=\"读取 attribute permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>读取 attribute</h4>\n<p>将<code class=\"language-text\">yui::generate_reader!</code>生成的 derive 宏作用在任意<code class=\"language-text\">struct</code>、<code class=\"language-text\">enum</code> 或<code class=\"language-text\">union</code> 上，即可对其使用<code class=\"language-text\">yui::get_attribute</code>和<code class=\"language-text\">yui::has_attribute</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> yui<span class=\"token punctuation\">::</span><span class=\"token punctuation\">{</span>get_attribute<span class=\"token punctuation\">,</span> has_attribute<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(MyDerive)]</span>\n<span class=\"token attribute attr-name\">#[StructAttr(\"some parameters\")]</span>\n<span class=\"token keyword\">struct</span> Foo <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[FieldAttr(\"some parameters\")]</span>\n    field<span class=\"token punctuation\">:</span> i32\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">some_fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assert!</span><span class=\"token punctuation\">(</span><span class=\"token function\">has_attribute!</span><span class=\"token punctuation\">(</span>Foo<span class=\"token punctuation\">,</span> StructAttr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert!</span><span class=\"token punctuation\">(</span><span class=\"token function\">has_attribute!</span><span class=\"token punctuation\">(</span>Foo<span class=\"token punctuation\">::</span>field<span class=\"token punctuation\">,</span> FieldAttr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> struct_attr1<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>StructAttribute1<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">get_attribute!</span><span class=\"token punctuation\">(</span>Foo<span class=\"token punctuation\">,</span> StructAttr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> field_attr1<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>StructAttribute1<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">get_attribute!</span><span class=\"token punctuation\">(</span>Foo<span class=\"token punctuation\">::</span>field<span class=\"token punctuation\">,</span> StructAttr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中<code class=\"language-text\">yui::has_attribute!</code>返回<code class=\"language-text\">bool</code>, <code class=\"language-text\">yui::get_attribute!(_, T)</code>返回<code class=\"language-text\">Option&lt;T&gt;</code>。</p>","timeToRead":7,"excerpt":"Yui 是笔者使用编写的第一个项目，本来是准备写一个ORM，但是在处理attribute的过程中写了很多重复的代码，所以决定将这一部分单独抽象成一个lib。 核心功能 Yui 的核心功能是根据 AttributeStructure 定义的 attribute pattern…","frontmatter":{"title":"Yui 项目简介","cover":"cover.jpg","date":"2020-06-08","category":"Rust","tags":["编程","Rust","Yui"],"author":"darkflames"},"fields":{"slug":"/yui-introduction"}},"prev":{"excerpt":"Yui 是笔者使用编写的第一个项目，本来是准备写一个ORM，但是在处理attribute的过程中写了很多重复的代码，所以决定将这一部分单独抽象成一个lib。 核心功能 Yui…","frontmatter":{"title":"Yui 项目简介","cover":"cover.jpg","date":"2020-06-08"},"fields":{"slug":"/yui-introduction"}},"next":{"excerpt":"Yui 是笔者使用编写的第一个项目，本来是准备写一个ORM，但是在处理attribute的过程中写了很多重复的代码，所以决定将这一部分单独抽象成一个lib。 核心功能 Yui…","frontmatter":{"title":"Yui 项目简介","cover":"cover.jpg","date":"2020-06-08"},"fields":{"slug":"/yui-introduction"}},"authors":{"edges":[{"node":{"uid":"darkflames","name":"Darkflames","image":"https://s.gravatar.com/avatar/9151e9b4581ec2930fdaad9677fbc748?s=80","url":"/","bio":"Developer / 业余摄影 / 胶片爱好者"}}]}},"pageContext":{"slug":"/yui-introduction","total":1}}}